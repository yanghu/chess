<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Keyboard Pcb Design |</title><meta name=Description content><meta property="og:title" content="Keyboard Pcb Design"><meta property="og:description" content="Feature highlights Initially, I wanted to build a split board. However, since I already have a split (crkbd), making a Arteus/Reviuge-like board makes more sense.
The design is using aggressive stagger (same column stagger like my split design), and 15 degree angle of columns.
Other features:
OLED status display RGB underglow Audio Encoder Design considerations for STM32 I&rsquo;ll be using F411 due to lack of F072 stock.
Tips for setup a stm chip in qmk: https://discord."><meta property="og:type" content="article"><meta property="og:url" content="http://yanghu.github.io/chess/posts/keyboard-pcb-design/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-11T18:37:25-07:00"><meta property="article:modified_time" content="2021-04-11T18:37:25-07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Keyboard Pcb Design"><meta name=twitter:description content="Feature highlights Initially, I wanted to build a split board. However, since I already have a split (crkbd), making a Arteus/Reviuge-like board makes more sense.
The design is using aggressive stagger (same column stagger like my split design), and 15 degree angle of columns.
Other features:
OLED status display RGB underglow Audio Encoder Design considerations for STM32 I&rsquo;ll be using F411 due to lack of F072 stock.
Tips for setup a stm chip in qmk: https://discord."><meta name=application-name content="Chess Study"><meta name=apple-mobile-web-app-title content="Chess Study"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://yanghu.github.io/chess/posts/keyboard-pcb-design/><link rel=prev href=http://yanghu.github.io/chess/posts/samples/post-sample/><link rel=next href=http://yanghu.github.io/chess/posts/chess-fundamentals/end-game-strategy/><link rel=stylesheet href=/chess/lib/normalize/normalize.min.css><link rel=stylesheet href=/chess/css/style.min.css><link rel=stylesheet href=/chess/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/chess/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Keyboard Pcb Design","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/yanghu.github.io\/chess\/posts\/keyboard-pcb-design\/"},"genre":"posts","wordCount":1255,"url":"http:\/\/yanghu.github.io\/chess\/posts\/keyboard-pcb-design\/","datePublished":"2021-04-11T18:37:25-07:00","dateModified":"2021-04-11T18:37:25-07:00","publisher":{"@type":"Organization","name":"xxxx","logo":"http:\/\/yanghu.github.io\/images\/avatar.png"},"author":{"@type":"Person","name":"Author"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/chess/ title="Chess Study" class=header-logo><span class=header-title-pre><i class='fas fa-chess fa-fw'></i></span>Chess Study</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/chess/posts/>Posts </a><a class=menu-item href=/chess/tags/>Tags </a><a class=menu-item href=/chess/categories/>Categories </a><a class=menu-item href=/chess/books/>Book Studies </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/chess/ title="Chess Study" class=header-logo><span class=header-title-pre><i class='fas fa-chess fa-fw'></i></span>Chess Study</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/chess/posts/ title>Posts</a><a class=menu-item href=/chess/tags/ title>Tags</a><a class=menu-item href=/chess/categories/ title>Categories</a><a class=menu-item href=/chess/books/ title>Book Studies</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><main class=main><div class="container content-article page-toc theme-classic"><div class=toc id=toc-auto><div class=toc-title>Contents</div><div class="toc-content always-active" id=toc-content-auto></div></div><div class=header-post><div class=post-title><div class=post-all-meta><div class=breadcrumbs><a href=/chess/>Home </a>/ <a href=/>Keyboard Pcb Design</a></div><h1 class="single-title animated flipInX">Keyboard Pcb Design</h1><div class=post-meta><div class=post-meta-line>&nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time class=timeago datetime=2021-04-11>2021-04-11</time>&nbsp;&nbsp;&nbsp;&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1255 words
&nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;6 minutes</div></div></div></div></div><article class="single toc-start"><div class="content-block content-block-first content-block-position"><div class=post><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#dma-channels-for-peripherals>DMA channels for peripherals</a><ul><li><a href=#f072-dma-details>F072 DMA details</a></li><li><a href=#f411-dma-details>F411 DMA details</a></li></ul></li><li><a href=#audio-driver>Audio Driver</a><ul><li><a href=#audio-with-dac>Audio with DAC</a></li><li><a href=#audio-with-pwm>Audio with PWM</a></li></ul></li><li><a href=#oled>OLED</a><ul><li><a href=#magic-fix>Magic fix</a></li><li><a href=#example-code>Example code</a></li></ul></li><li><a href=#backlight-rgb>Backlight RGB:</a><ul><li><a href=#rgb-driver-using-pwm>RGB driver using PWM</a></li><li><a href=#rgb-driver-spi>RGB driver SPI</a></li></ul></li></ul><ul><li><a href=#mcu>MCU</a></li><li><a href=#reset-button-circuit>Reset button circuit</a></li><li><a href=#fuse>Fuse</a></li><li><a href=#schottky-diode>Schottky Diode</a></li><li><a href=#resistors-and-capacitors>Resistors and capacitors</a></li></ul></nav></div></div><h1 id=feature-highlights>Feature highlights</h1><p>Initially, I wanted to build a split board. However, since I already have a
split (crkbd), making a Arteus/Reviuge-like board makes more sense.</p><p>The design is using aggressive stagger (same column stagger like my split
design), and 15 degree angle of columns.</p><p>Other features:</p><ul><li>OLED status display</li><li>RGB underglow</li><li>Audio</li><li>Encoder</li></ul><h1 id=design-considerations-for-stm32>Design considerations for STM32</h1><p>I&rsquo;ll be using F411 due to lack of F072 stock.</p><p>Tips for setup a stm chip in qmk: <a href=https://discord.com/channels/440868230475677696/440870965728116754/839978277489082370 target=_blank rel="noopener noreffer">https://discord.com/channels/440868230475677696/440870965728116754/839978277489082370</a></p><p>Snippet to find keyboards that uses a certain chip:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> % git grep &#39;MCU\s*=\s*STM32F411&#39; keyboards/
</span></span><span class=line><span class=cl> keyboards/handwired/onekey/blackpill_f411/rules.mk:MCU = STM32F411
</span></span><span class=line><span class=cl> keyboards/handwired/onekey/blackpill_f411_tinyuf2/rules.mk:MCU = STM32F411
</span></span><span class=line><span class=cl> keyboards/handwired/pill60/blackpill_f411/rules.mk:MCU = STM32F411
</span></span><span class=line><span class=cl> keyboards/handwired/riblee_f411/rules.mk:MCU = STM32F411
</span></span><span class=line><span class=cl> keyboards/matrix/m20add/rules.mk:MCU = STM32F411
</span></span><span class=line><span class=cl> keyboards/matrix/noah/rules.mk:MCU = STM32F411
</span></span><span class=line><span class=cl> keyboards/tkw/grandiceps/rules.mk:MCU = STM32F411
</span></span><span class=line><span class=cl> keyboards/tkw/stoutgat/v2/f411/rules.mk:MCU = STM32F411
</span></span><span class=line><span class=cl> keyboards/zvecr/zv48/f411/rules.mk:MCU = STM32F411
</span></span></code></pre></td></tr></table></div></div><h2 id=dma-channels-for-peripherals>DMA channels for peripherals</h2><p>Peripherals like I2C, SPI and ADC, DAC uses DMA channels. PWM also can use DMA
for better performance, for example, for LED dreivers. STM32F072 has
7 DMA channels(details can be found in reference doc). When choosing
peripherals, we need to choose carefully so that DMA channels won&rsquo;t collide.</p><p>QMK uses DMA for the following:</p><ul><li>WS2812 LED: pwm driver uses DMA+PWM.</li><li>Audio: DAC driver uses DMA. PWM driver doesn&rsquo;t use DMA.</li><li>OLED: Uses I2C which uses DMA channels.</li></ul><h3 id=f072-dma-details>F072 DMA details</h3><p>F072 only has one DMA controller(<code>DMA1</code>), which has 1 channel, with 7 streams.</p><ul><li>I2C1: uses DMA streams 6/7(or 2/3). (Requires <a href=#oled rel>magic boot code</a>
to configure.)</li><li>DAC1/2: uses DMA streams 3 and 4.</li><li>SPI1: streams 2/3.</li><li>SPI2: streams 4/5 or 6/7.</li><li>TIM3_CH1: stream 4</li><li>TIM1_CH1: stream 2</li></ul><h3 id=f411-dma-details>F411 DMA details</h3><p>F411 has 2 DMA controllers, each has 8 channels and each channel with 8 streams.</p><p>Summary of DMA usage in my design:</p><p>|&mdash;&mdash;&mdash;&ndash;|&mdash;&mdash;&mdash;&mdash;|&mdash;&mdash;-|&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;|&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-|</p><table><thead><tr><th>Feature</th><th>QMK Driver</th><th>Pins</th><th>Peripheral</th><th>DMA channels</th></tr></thead><tbody><tr><td>OLED</td><td>I2C</td><td>PB6/7</td><td>I2C1</td><td>DMA1-Chan1-Stream5/6</td></tr><tr><td>Audio</td><td>PWM</td><td>PA8</td><td>TIM1_CH1 + TIM6 GPT</td><td>N/A</td></tr><tr><td>RGB LED</td><td>PWM</td><td>PB1</td><td>TIM3_CH4</td><td>DMA1-Chan5-Stream2</td></tr><tr><td>RGB (alt)</td><td>SPI1</td><td>PB5</td><td>SPI1</td><td>DMA2-Chan3-Stream2/3</td></tr><tr><td>&mdash;&mdash;&mdash;&ndash;</td><td>&mdash;&mdash;&mdash;&mdash;</td><td>&mdash;&mdash;-</td><td>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</td><td>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</td></tr></tbody></table><h2 id=audio-driver>Audio Driver</h2><p>Two options: DAC and PWM. DAC would occupy one or two DMA channels. PWM doesn&rsquo;t
use DMA.</p><h3 id=audio-with-dac>Audio with DAC</h3><p>Using two pins can provides higher voltage amplitude and louder volume.</p><ul><li>Pins(A4/A5). <a href="https://docs.qmk.fm/#/audio_driver?id=arm" target=_blank rel="noopener noreffer">ref</a>,
<a href="https://docs.qmk.fm/#/feature_audio?id=arm-based-boards" target=_blank rel="noopener noreffer">ref2</a></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// Audio configuration
</span></span><span class=line><span class=cl>#define AUDIO_PIN A4
</span></span><span class=line><span class=cl>#define AUDIO_PIN_ALT A5
</span></span><span class=line><span class=cl>#define AUDIO_PIN_ALT_AS_NEGATIVE
</span></span><span class=line><span class=cl>#define A4_AUDIO
</span></span><span class=line><span class=cl>#ifndef STARTUP_SONG
</span></span><span class=line><span class=cl>#    define STARTUP_SONG SONG(STARTUP_SOUND)
</span></span><span class=line><span class=cl>#endif  // STARTUP_SONG
</span></span></code></pre></td></tr></table></div></div><h3 id=audio-with-pwm>Audio with PWM</h3><ul><li>Use any timer&rsquo;s PWM to output square wave. This only support single pin mode.</li></ul><p>We use <code>TIM3_CH1</code> as example. (use tim6 for audio state timer)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>//halconf.h:
</span></span><span class=line><span class=cl>#define HAL_USE_PWM                 TRUE
</span></span><span class=line><span class=cl>#define HAL_USE_PAL                 TRUE
</span></span><span class=line><span class=cl>#define HAL_USE_GPT                 TRUE
</span></span><span class=line><span class=cl>#include_next &lt;halconf.h&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// mcuconf.h:
</span></span><span class=line><span class=cl>#include_next &lt;mcuconf.h&gt;
</span></span><span class=line><span class=cl>#undef STM32_PWM_USE_TIM1
</span></span><span class=line><span class=cl>#define STM32_PWM_USE_TIM1                  TRUE
</span></span><span class=line><span class=cl>#undef STM32_GPT_USE_TIM6
</span></span><span class=line><span class=cl>#define STM32_GPT_USE_TIM6                  TRUE
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//config.h:
</span></span><span class=line><span class=cl>// Use pin C6(TIM3_CH1) PWM
</span></span><span class=line><span class=cl>#define AUDIO_PIN A8
</span></span><span class=line><span class=cl>#define AUDIO_PWM_PAL_MODE 1
</span></span><span class=line><span class=cl>#define AUDIO_PWM_DRIVER PWMD1
</span></span><span class=line><span class=cl>#define AUDIO_PWM_CHANNEL 1
</span></span><span class=line><span class=cl>#define AUDIO_STATE_TIMER GPTD6
</span></span></code></pre></td></tr></table></div></div><h2 id=oled>OLED</h2><p>I2C: Use I2C1(pins B6/7). <a href="https://docs.qmk.fm/#/i2c_driver?id=arm-configuration" target=_blank rel="noopener noreffer">ref</a></p><p>Note that, pull up resistors(4.7kOhm) are needed for I2C pins.</p><h3 id=magic-fix>Magic fix</h3><p>For F072, extra configuration is needed to use I2C1 correctly. For details, see
<a href=https://discord.com/channels/440868230475677696/440868230475677698/837318487759388682 target=_blank rel="noopener noreffer">discord</a>,
<a href=https://discord.com/channels/440868230475677696/440868230475677698/837292700051046400 target=_blank rel="noopener noreffer">discord2</a></p><h3 id=example-code>Example code</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// example config: https://github.com/qmk/qmk_firmware/blob/master/keyboards/xelus/kangaroo/config.h
</span></span><span class=line><span class=cl>//set I2C1_SCL_PAL_MODE and I2C1_SDA_PAL_MODE to 1. (PINs B6/7)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#define I2C1_TIMINGR_SCLDEL 3U
</span></span><span class=line><span class=cl>#define I2C1_TIMINGR_SDADEL 1U
</span></span><span class=line><span class=cl>#define I2C1_TIMINGR_SCLH     3U
</span></span><span class=line><span class=cl>#define I2C1_TIMINGR_SCLL   9U
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//Copy board_init() from https://github.com/qmk/qmk_firmware/blob/master/keyboards/xelus/kangaroo/kangaroo.c :
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>void board_init(void) {
</span></span><span class=line><span class=cl>  SYSCFG-&gt;CFGR1 |= SYSCFG_CFGR1_I2C1_DMA_RMP;
</span></span><span class=line><span class=cl>  SYSCFG-&gt;CFGR1 &amp;= ~(SYSCFG_CFGR1_SPI2_DMA_RMP);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//The problem is that platforms/chibios/GENERIC_STM32_F072XB/configs/mcuconf.h contains:
</span></span><span class=line><span class=cl>#define STM32_I2C_I2C1_RX_DMA_STREAM STM32_DMA_STREAM_ID(1, 7)
</span></span><span class=line><span class=cl>#define STM32_I2C_I2C1_TX_DMA_STREAM STM32_DMA_STREAM_ID(1, 6)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//But this is actually an alternate configuration for I2C1 DMA streams, and it needs to be enabled by setting the SYSCFG_CFGR1_I2C1_DMA_RMP bit.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//The SYSCFG_CFGR1_SPI2_DMA_RMP clearing part might not actually be needed (the power-on state for this bit should be 0), but you can include it just to be sure.
</span></span></code></pre></td></tr></table></div></div><h2 id=backlight-rgb>Backlight RGB:</h2><ul><li>LED: use <a href=https://lcsc.com/product-detail/Light-Emitting-Diodes-LED_5050-RGBIntegrated-Light_C114584.html target=_blank rel="noopener noreffer">WS2812S</a></li></ul><h3 id=rgb-driver-using-pwm>RGB driver using PWM</h3><p>Uses PWM and DMA. Here I&rsquo;m using <code>TIM3_CH4</code> on pin <code>B1</code> as output, and connect
it with pull up resistor to 5V. (<code>B1</code> is a 5v tolerant pin)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// rules.mk
</span></span><span class=line><span class=cl>RGBLIGHT_DRIVER = WS2812
</span></span><span class=line><span class=cl>// config.h 
</span></span><span class=line><span class=cl>#define RGB_DI_PIN B1
</span></span><span class=line><span class=cl>#define WS2812_PWM_DRIVER PWMD3
</span></span><span class=line><span class=cl>#define WS2812_PWM_CHANNEL 4
</span></span><span class=line><span class=cl>#define WS2812_EXTERNAL_PULLUP
</span></span><span class=line><span class=cl>// Set B1 to tim3 ch4
</span></span><span class=line><span class=cl>#define WS2812_PWM_PAL_MODE 2
</span></span><span class=line><span class=cl>// DMA request mapped on this DMA channel only if the corresponding remapping 
</span></span><span class=line><span class=cl>// bit is cleared in the SYSCFG_CFGR1 register. For more details, please refer 
</span></span><span class=line><span class=cl>// to Section 9.1.1: SYSCFG configuration register 1 (SYSCFG_CFGR1) on page165.
</span></span><span class=line><span class=cl>#define WS2812_DMA_STREAM STM32_DMA1_STREAM2
</span></span><span class=line><span class=cl>#define WS2812_DMA_CHANNEL 5
</span></span></code></pre></td></tr></table></div></div><p>If using pin B15(tim15) (F072)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// rules.mk
</span></span><span class=line><span class=cl>RGBLIGHT_DRIVER = WS2812
</span></span><span class=line><span class=cl>// config.h 
</span></span><span class=line><span class=cl>#define RGB_DI_PIN B15
</span></span><span class=line><span class=cl>#define WS2812_EXTERNAL_PULLUP
</span></span><span class=line><span class=cl>// using TIM15 channel 2
</span></span><span class=line><span class=cl>#define WS2812_PWM_DRIVER PWMD15
</span></span><span class=line><span class=cl>#define WS2812_PWM_CHANNEL 2
</span></span><span class=line><span class=cl>// Set B15 to tim15 ch2
</span></span><span class=line><span class=cl>#define WS2812_PWM_PAL_MODE 1
</span></span><span class=line><span class=cl>// DMA setup needs to be verified.
</span></span><span class=line><span class=cl>#define WS2812_DMA_STREAM STM32_DMA1_STREAM5
</span></span><span class=line><span class=cl>//mcuconf.h if using tim15
</span></span><span class=line><span class=cl>//#define STM32_TIM15_SUPPRESS_ISR
</span></span></code></pre></td></tr></table></div></div><h3 id=rgb-driver-spi>RGB driver SPI</h3><p>Use <code>SPI2</code>(B15). <a href="https://docs.qmk.fm/#/ws2812_driver?id=spi" target=_blank rel="noopener noreffer">ref</a>
<a href="https://docs.qmk.fm/#/spi_driver?id=chibiosarm-configuration" target=_blank rel="noopener noreffer">spi</a>.
This requires other spi pins unused.(miso and sck, e.g. B13 and B14)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>#define WS2812_SPI SPID2
</span></span><span class=line><span class=cl>// Pins 15/14/13
</span></span><span class=line><span class=cl>#define WS2812_SPI_MOSI_PAL_MODE 0
</span></span><span class=line><span class=cl>#define WS2812_SPI_MOSO_PAL_MODE 0
</span></span><span class=line><span class=cl>#define WS2812_SPI_SCK_PAL_MODE 0
</span></span></code></pre></td></tr></table></div></div><p>Note: Extra setup is needed for F072 <code>B15</code> pin. <a href=https://discord.com/channels/440868230475677696/440868230475677698/838685140661436417 target=_blank rel="noopener noreffer">details</a></p><p>The fix is to define <code>#define WS2812_SPI_USE_CIRCULAR_BUFFER</code>. The flag is only
available in <code>develop</code> branch. Anoth</p><h1 id=component-choices>Component choices</h1><p>Use this <a href=https://yaqwsx.github.io/jlcparts/#/ target=_blank rel="noopener noreffer">site</a> to search JLCPCB parts
for SMD assembly service availability and price.</p><p>Summary:</p><p>|&mdash;&mdash;&mdash;&mdash;&mdash;-|&mdash;&mdash;&mdash;&mdash;&mdash;|&mdash;&mdash;&mdash;&ndash;|&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-|&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;|</p><table><thead><tr><th>Component</th><th>Model</th><th>JLCPCB PN</th><th>Count</th><th>Notes</th></tr></thead><tbody><tr><td>MCU</td><td>STM32F072CBU6</td><td>C92504</td><td>1</td><td></td></tr><tr><td>Regulator</td><td>XC6206P332MR</td><td>C5446</td><td>1</td><td>3.3V fixed output</td></tr><tr><td>BJT</td><td>MMBT3904</td><td>C20526</td><td>1</td><td>for reset circuit, need add resistors</td></tr><tr><td>diode</td><td>1N4148</td><td>C81598</td><td>for both switches and reset button.</td><td></td></tr><tr><td>Fuse</td><td>JK-MSMD050</td><td>C369167</td><td>For USB bus voltage protection</td><td></td></tr><tr><td>Schottky Diode</td><td>SS14</td><td>C2480</td><td>between voltage regulartor</td><td></td></tr><tr><td>Buzzer</td><td>KLJ-1625</td><td>C201041</td><td>smd pizeo buzzer</td><td></td></tr><tr><td>&mdash;&mdash;&mdash;&mdash;&mdash;-</td><td>&mdash;&mdash;&mdash;&mdash;&mdash;</td><td>&mdash;&mdash;&mdash;&ndash;</td><td>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</td><td></td></tr></tbody></table><h2 id=mcu>MCU</h2><p>I&rsquo;m using STM32 MCU, which is more powerful than the atmega on pro micros.
The atmega32u4 is 8 bit processor and only has 32K memory size. In comparison,
the Arm chips are 32bit, and has more program memory(F072C8 has 64K, F072CB has
128K, F411 has 256K/521K flash and 128K SRAM).</p><p>Initially I wanted to use STM32F072CBU6, which is also used in Ferris. However,
it became OOS and I had to pick another chip. I found STM32F411 whixh id more
powerful.</p><p>One caveat is that F4 series doesn&rsquo;t have built-in eeprom emulator. An
external eeprom chip is needed, otherwise some features are not usable, like
bootmagic, on-board settings(default layers, for example).</p><h2 id=reset-button-circuit>Reset button circuit</h2><p>To reset(and enter bootloader), we need to trigger both NRST and BOOT0 pins.
This <a href=http://acheronproject.com/reset_article/principle.html#conclusion target=_blank rel="noopener noreffer">guide</a>
suggested 3 variants and I&rsquo;m using the middle one for simplicity. For this
circuit, we need a transistor. I&rsquo;m not using the prebiased one shown there
(50V, 100mA, 2.2kOhm and 47kOhm) since it&rsquo;s extended part and has $3 extra
charge. Instead I&rsquo;m using a 40V, 200mA NPN transistor and adding external
resistors.</p><h2 id=fuse>Fuse</h2><p>Ferris used &ldquo;Polymeric 15V 1A 100ms 750mΩ 1206 PTC Resettable Fuses RoHS&rdquo;,
however the model is OOS, so I searched on LCSC and found C369167
which has similar spec. For the diode, Ferris used C435473, and I&rsquo;m using the
same.</p><h2 id=schottky-diode>Schottky Diode</h2><p>Ferris used RB060MM-30, which is 30V vr, 490mV vf. I use SS14 which is basic
part in JLCPCB. It is &ldquo;40V 1A 550mV @ 1A&rdquo; which is pretty close.</p><h2 id=resistors-and-capacitors>Resistors and capacitors</h2><p>I&rsquo;m using all 0603 footprint.</p><h1 id=todo>TODO</h1><p>Some changes to apply to next design:</p><ul><li>Add 4.7k pull up to i2c pins.</li><li>Use 8Mhz crystal instead of 25MHz. <a href=https://discord.com/channels/440868230475677696/440870965728116754/840697199058485248 target=_blank rel="noopener noreffer">ref</a></li></ul></div><div class=post><div class=post-info-share><span><a class="share-icon share-twitter" href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://yanghu.github.io/chess/posts/keyboard-pcb-design/ data-title="Keyboard Pcb Design"><i class="fab fa-twitter fa-fw"></i></a><a class="share-icon share-facebook" href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://yanghu.github.io/chess/posts/keyboard-pcb-design/><i class="fab fa-facebook-square fa-fw"></i></a><a class="share-icon share-reddit" href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=http://yanghu.github.io/chess/posts/keyboard-pcb-design/><i class="fab fa-reddit fa-fw"></i></a><a class="share-icon share-weibo" href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://yanghu.github.io/chess/posts/keyboard-pcb-design/ data-title="Keyboard Pcb Design"><i class="fab fa-weibo fa-fw"></i></a></span></div><div class=post-footer id=post-footer><div class=post-navigation><div class="post-nav-box nav-box-prev"><a class=nav-box href=/chess/posts/samples/post-sample/><span class=nav-icon><svg aria-hidden="true" data-prefix="fas" data-icon="chevron-circle-left" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 504C119 504 8 393 8 256S119 8 256 8s248 111 248 248-111 248-248 248zM142.1 273l135.5 135.5c9.4 9.4 24.6 9.4 33.9.0l17-17c9.4-9.4 9.4-24.6.0-33.9L226.9 256l101.6-101.6c9.4-9.4 9.4-24.6.0-33.9l-17-17c-9.4-9.4-24.6-9.4-33.9.0L142.1 239c-9.4 9.4-9.4 24.6.0 34z"/></svg></span><div style=text-align:right;padding-left:10px><div class=nav-text-h>Next article</div><span class=nav-text>Post Sample</span></div></a></div><div class="post-nav-box nav-box-next"><a class=nav-box href=/chess/posts/chess-fundamentals/end-game-strategy/><div style=padding-right:10px><div class=nav-text-h>Next article</div><span class=nav-text>5. End Game Strategy</span></div><span class=nav-icon><svg aria-hidden="true" data-prefix="fas" data-icon="chevron-circle-right" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 8c137 0 248 111 248 248S393 504 256 504 8 393 8 256 119 8 256 8zm113.9 231L234.4 103.5c-9.4-9.4-24.6-9.4-33.9.0l-17 17c-9.4 9.4-9.4 24.6.0 33.9L285.1 256 183.5 357.6c-9.4 9.4-9.4 24.6.0 33.9l17 17c9.4 9.4 24.6 9.4 33.9.0L369.9 273c9.4-9.4 9.4-24.6.0-34z"/></svg></span></a></div></div></div></div></div><div id=toc-final></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.111.3">Hugo</a> | Theme - <a href="https://ublogger.netlify.app/?utm_source=http://yanghu.github.io/chess/&utm_medium=footer&utm_campaign=config&utm_term=1.2.0" target=_blank title="uBlogger 1.2.0"><i class="fas fa-pencil-alt fa-fw"></i> uBlogger</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span>2021 - 2023</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/chess/css/fen.css><link rel=stylesheet href=/chess/css/FigurineSymbol.css><script src=/chess/lib/smooth-scroll/smooth-scroll.min.js></script><script src=/chess/lib/lazysizes/lazysizes.min.js></script><script src=/chess/lib/clipboard/clipboard.min.js></script><script src=/chess/lib/sharer/sharer.min.js></script><script src=/chess/js/fen_diagram.js></script><script>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10}}</script><script src=/chess/js/theme.min.js></script><script src=/chess/js/jquery-3.5.1.min.js></script></body></html>